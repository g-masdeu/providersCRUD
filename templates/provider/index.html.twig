{% extends 'base.html.twig' %}

{% block body %}
{% set colors = {'hotel': 'primary', 'crucero': 'success', 'esqui': 'info text-dark', 'parque': 'warning text-dark'} %}

<div class="container mt-4">
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label == 'success' ? 'success' : 'warning' }} alert-dismissible fade show shadow-sm flash-message">
                <i class="bi {{ label == 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle' }} me-2"></i>
                {{ message|trans }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endfor %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-secondary">{{ 'list.title'|trans }}</h2>
        <button class="btn btn-primary shadow-sm" onclick="loadForm('{{ path('app_provider_new') }}', '{{ 'modal.new_title'|trans }}')">
            <i class="bi bi-plus-circle me-1"></i> {{ 'btn.add'|trans }}
        </button>
    </div>

    <div class="bg-body shadow-sm rounded p-4">
        <div class="row mb-2 pb-3 border-bottom align-items-end">
            <div class="col-md-4">
                <label class="form-label small fw-bold text-muted">{{ 'filter.label'|trans }}</label>
                <select id="filterType" class="form-select form-select-sm">
                    <option value="" selected disabled>{{ 'filter.placeholder'|trans }}</option>
                    <option value="{{ 'type.hotel'|trans }}">{{ 'type.hotel'|trans }}</option>
                    <option value="{{ 'type.crucero'|trans }}">{{ 'type.crucero'|trans }}</option>
                    <option value="{{ 'type.esqui'|trans }}">{{ 'type.esqui'|trans }}</option>
                    <option value="{{ 'type.parque'|trans }}">{{ 'type.parque'|trans }}</option>
                </select>
            </div>
            <div class="col-md-8 text-end">
                <small class="text-muted italic">{{ 'filter.active'|trans }}:</small>
                <div id="activeFiltersContainer" class="mt-1">
                    <span id="noFiltersMsg" class="text-muted small italic">{{ 'filter.none'|trans }}</span>
                </div>
            </div>
        </div>

        <table id="providerTable" class="table table-hover dt-responsive nowrap" style="width:100%">
            <thead>
                <tr class="table-light">
                    <th>{{ 'table.name'|trans }}</th>
                    <th>{{ 'table.email'|trans }}</th>
                    <th>{{ 'table.phone'|trans }}</th>
                    <th>{{ 'table.type'|trans }}</th>
                    <th>{{ 'table.created'|trans }}</th>
                    <th>{{ 'table.updated'|trans }}</th>
                    <th class="text-end">{{ 'table.actions'|trans }}</th>
                </tr>
            </thead>
            <tbody>
            {% for provider in providers %}
                <tr>
                    <td class="fw-bold">{{ provider.name }}</td>
                    <td>{{ provider.email }}</td>
                    <td>{{ provider.phone }}</td>
                    <td><span class="badge bg-{{ colors[provider.type]|default('secondary') }}">{{ ('type.' ~ provider.type)|trans }}</span></td>
                    <td class="small text-muted">{{ provider.createdAt|date('d/m/Y H:i') }}</td>
                    <td class="small text-muted">{{ provider.updatedAt|date('d/m/Y H:i') }}</td>
                    <td class="text-end">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-warning" onclick="loadForm('{{ path('app_provider_edit', {'id': provider.id}) }}', '{{ 'modal.edit_title'|trans }}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                    onclick="confirmDelete('{{ path('app_provider_delete', {'id': provider.id}) }}', '{{ csrf_token('delete' ~ provider.id) }}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# Modales (Mantienen su estructura pero con textos din√°micos) #}
<div class="modal fade" id="modalApp" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title fw-bold" id="modalTitle">{{ 'modal.loading'|trans }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" id="modalBody"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i> {{ 'delete.title'|trans }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <p class="mb-0">{{ 'delete.message'|trans }}</p>
            </div>
            <div class="modal-footer border-0 d-flex justify-content-center pb-4">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">{{ 'btn.cancel'|trans }}</button>
                <form id="deleteForm" method="post">
                    <input type="hidden" name="_token" id="deleteToken">
                    <button type="submit" class="btn btn-danger">{{ 'btn.delete_confirm'|trans }}</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    let bsModal;
    let activeTypes = []; 
    const deleteModalBS = new bootstrap.Modal(document.getElementById('deleteModal'));

    // Mapa de colores traducidos para los badges
    const typeColors = {
        '{{ 'type.hotel'|trans }}': 'primary',
        '{{ 'type.crucero'|trans }}': 'success',
        '{{ 'type.esqui'|trans }}': 'info text-dark',
        '{{ 'type.parque'|trans }}': 'warning text-dark'
    };

    $(document).ready(function() {
        const table = $('#providerTable').DataTable({
            responsive: true,
            language: { 
                url: `https://cdn.datatables.net/plug-ins/1.13.6/i18n/${'{{ app.request.locale }}' === 'ca' ? 'ca' : '{{ app.request.locale }}'}.json` 
            },
            columnDefs: [{ orderable: false, targets: 6 }],
            order: [[4, 'desc']],
            dom: '<"row mb-3"<"col-md-6"l><"col-md-6"f>>rtip', 
        });

        $('#filterType').on('change', function() {
            const val = $(this).val();
            if (val && !activeTypes.includes(val)) {
                activeTypes.push(val);
                renderBadges(table);
            }
            $(this).val(""); 
        });

        function renderBadges(tableInstance) {
            const container = $('#activeFiltersContainer');
            container.empty();
            if (activeTypes.length === 0) {
                container.append('<span class="text-muted small italic">{{ 'filter.none'|trans }}</span>');
                tableInstance.column(3).search('').draw(); 
                return;
            }
            activeTypes.forEach(type => {
                const colorClass = typeColors[type] || 'secondary';
                container.append(`<span class="badge bg-${colorClass} me-1 p-2 shadow-sm">${type} <i class="bi bi-x-lg ms-2 btn-remove-filter" style="cursor:pointer" data-type="${type}"></i></span>`);
            });
            tableInstance.column(3).search(activeTypes.join('|'), true, false).draw();
        }

        $(document).on('click', '.btn-remove-filter', function() {
            activeTypes = activeTypes.filter(t => t !== $(this).data('type'));
            renderBadges(table);
        });

        bsModal = new bootstrap.Modal(document.getElementById('modalApp'));

        setTimeout(() => {
            $('.flash-message').each(function() {
                const alert = bootstrap.Alert.getOrCreateInstance(this);
                if (alert) alert.close();
            });
        }, 3000);
    });

    function loadForm(url, title) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalBody').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
        bsModal.show();
        fetch(url).then(r => r.text()).then(html => {
            document.getElementById('modalBody').innerHTML = html;
            setupFormSubmission(url);
        });
    }

    function setupFormSubmission(url) {
        const form = document.querySelector('#modalBody form');
        if (!form) return;
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            fetch(url, { method: 'POST', body: new FormData(form) }).then(res => {
                if (res.redirected) window.location.href = res.url;
                else res.text().then(html => {
                    document.getElementById('modalBody').innerHTML = html;
                    setupFormSubmission(url);
                });
            });
        });
    }

    function confirmDelete(url, token) {
        document.getElementById('deleteForm').action = url;
        document.getElementById('deleteToken').value = token;
        deleteModalBS.show();
    }
</script>
{% endblock %}